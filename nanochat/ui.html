<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NanoChat</title>
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <style>
        :root {
            color-scheme: light;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #ffffff;
            color: #111827;
            min-height: 100dvh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #ffffff;
            padding: 1.25rem 1.5rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-logo {
            height: 32px;
            width: auto;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            color: #111827;
        }

    
        .new-conversation-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #ffffff;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .new-conversation-btn:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
            color: #374151;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            background-color: #ffffff;
        }

        .chat-wrapper {
            max-width: 48rem;
            margin: 0 auto;
            padding: 2rem 1.5rem 3rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .message {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 0.5rem;
            color: #0d0d0d;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            white-space: pre-wrap;
            line-height: 1.6;
            max-width: 100%;
        }

        .message.assistant {
            position: relative;
        }

        .message.assistant .message-content {
            background: transparent;
            border: none;
            padding: 0.25rem 0;
            cursor: pointer;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-left: -0.5rem;
            transition: background-color 0.2s ease;
        }

        .logit-lens-toggle {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .message.assistant:hover .logit-lens-toggle {
            opacity: 1;
        }

        .logit-lens-toggle:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
            color: #374151;
        }

        .logit-lens-toggle.active {
            opacity: 1;
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        .logit-lens-panel {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            display: none;
        }

        .logit-lens-panel.active {
            display: block;
        }

        .layer-scrubber {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .layer-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
        }

        .layer-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        .layer-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .layer-info {
            min-width: 80px;
            text-align: center;
            font-size: 0.875rem;
            color: #374151;
        }

        .logit-lens-output {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            padding: 0.75rem;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .token-stable {
            color: #6b7280;
        }

        .token-changing {
            color: #dc2626;
            font-weight: 600;
        }

        .logit-lens-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .logit-lens-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #ffffff;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logit-lens-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }

        .logit-lens-btn.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        .logit-lens-toggle-container {
            padding: 0.75rem 1rem 0.5rem;
            border-top: 1px solid #f3f4f6;
            margin-top: 0.5rem;
        }

        .message.assistant .message-content:hover {
            background-color: #f9fafb;
        }

        .message.user .message-content {
            background-color: #f3f4f6;
            border-radius: 1.25rem;
            padding: 0.8rem 1rem;
            max-width: 65%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .message.user .message-content:hover {
            background-color: #e5e7eb;
        }

        .message.console .message-content {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'Courier New', monospace;
            font-size: 0.875rem;
            background-color: #fafafa;
            padding: 0.75rem 1rem;
            color: #374151;
            max-width: 80%;
        }

        .input-container {
            background-color: #ffffff;
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            position: relative; /* Needed for positioning the viz container */
        }

        .input-wrapper {
            max-width: 48rem;
            margin: 0 auto;
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .viz-container {
            position: absolute;
            bottom: calc(100% + 1rem); /* Position it above the input area */
            right: 0;
            width: 300px;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: #4b5563;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .viz-container.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .viz-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #111827;
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            outline: none;
            min-height: 54px;
            max-height: 200px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .chat-input::placeholder {
            color: #9ca3af;
        }

        .chat-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-button {
            flex-shrink: 0;
            padding: 0;
            width: 54px;
            height: 54px;
            border: 1px solid #111827;
            border-radius: 0.75rem;
            background-color: #111827;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }

        .send-button:hover:not(:disabled) {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .send-button:disabled {
            cursor: not-allowed;
            border-color: #d1d5db;
            background-color: #e5e7eb;
            color: #9ca3af;
        }

        .typing-indicator {
            display: inline-block;
            color: #6b7280;
            letter-spacing: 0.15em;
        }

        .typing-indicator::after {
            content: '¬∑¬∑¬∑';
            animation: typing 1.4s infinite;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.2; }
            30% { opacity: 1; }
        }

        .error-message {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="new-conversation-btn" onclick="newConversation()" title="New Conversation (Ctrl+Shift+N)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14"></path>
                    <path d="M5 12h14"></path>
                </svg>
            </button>
            <h1>nanochat</h1>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-wrapper" id="chatWrapper">
            <!-- Messages will be added here -->
        </div>
    </div>

    <div class="input-container">
        <!-- Add the new visualization container here -->
        <div id="vizContainer" class="viz-container"></div>
        <div class="input-wrapper">
            <textarea
                id="chatInput"
                class="chat-input"
                placeholder="Ask anything"
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button id="sendButton" class="send-button" onclick="sendMessage()" disabled>
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 2L11 13"></path>
                    <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
                </svg>
            </button>
        </div>
        <div class="logit-lens-toggle-container">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="logitLensToggle" class="mr-2" onchange="toggleLogitLensSetting()">
                <span class="text-sm text-gray-600">Enable Logit Lens for next response</span>
            </label>
        </div>
    </div>

    <script>
        const API_URL = '';
        const chatContainer = document.getElementById('chatContainer');
        const chatWrapper = document.getElementById('chatWrapper');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const vizContainer = document.getElementById('vizContainer');

        let messages = [];
        let isGenerating = false;
        let currentTemperature = 0.8;
        let currentTopK = 50;
        let includeLogitLens = false;
        let logitLensData = {}; // Store logit-lens data per message
        let animationIntervals = {}; // Store animation intervals

        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            sendButton.disabled = !this.value.trim() || isGenerating;
        });

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        document.addEventListener('keydown', function(event) {
            // Ctrl+Shift+N for new conversation
            if (event.ctrlKey && event.shiftKey && event.key === 'N') {
                event.preventDefault();
                if (!isGenerating) {
                    newConversation();
                }
            }
        });

        function newConversation() {
            messages = [];
            chatWrapper.innerHTML = '';
            chatInput.value = '';
            chatInput.style.height = 'auto';
            sendButton.disabled = false;
            isGenerating = false;
            logitLensData = {}; // Clear logit lens data
            vizContainer.classList.remove('visible'); // Hide visualization
            vizContainer.innerHTML = ''; // Clear it
            chatInput.focus();
        }

        // Logit-Lens Functions
        function toggleLogitLens(messageIndex) {
            const playButton = document.querySelector(`.logit-lens-toggle[data-message-index="${messageIndex}"]`);
            const panel = document.querySelector(`.logit-lens-panel[data-message-index="${messageIndex}"]`);

            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                playButton.classList.remove('active');
                playButton.innerHTML = '‚ñ∂';
            } else {
                panel.classList.add('active');
                playButton.classList.add('active');
                playButton.innerHTML = '‚è∏';

                // If we have data, update display
                if (logitLensData[messageIndex]) {
                    updateLayerDisplay(messageIndex, 32); // Start at final layer
                }
            }
        }

        function updateLayerDisplay(messageIndex, layerIndex) {
            const output = document.querySelector(`.logit-lens-output[data-message-index="${messageIndex}"]`);
            const layerInfo = document.querySelector(`.logit-lens-panel[data-message-index="${messageIndex}"] .layer-scrubber .layer-info`);
            const data = logitLensData[messageIndex];

            if (!data || !data.layer_texts || layerIndex >= data.layer_texts.length) {
                output.textContent = 'No logit-lens data available for this layer.';
                return;
            }

            const layerName = data.layer_names[layerIndex];
            const layerText = data.layer_texts[layerIndex];
            const finalText = data.layer_texts[data.layer_texts.length - 1];

            // Update layer info
            layerInfo.innerHTML = `
                <div class="font-semibold">${layerName}</div>
                <div class="text-xs text-gray-500">${layerIndex}/${data.layer_texts.length - 1}</div>
            `;

            // Create highlighted text
            const highlightedText = createHighlightedText(layerText, finalText);
            output.innerHTML = highlightedText;
        }

        function createHighlightedText(currentText, finalText) {
            if (!currentText || !finalText) return currentText || '';

            const currentTokens = currentText.match(/\S+|\s+/g) || [];
            const finalTokens = finalText.match(/\S+|\s+/g) || [];

            return currentTokens.map((token, index) => {
                const isStable = token === (finalTokens[index] || '');
                const cssClass = isStable ? 'token-stable' : 'token-changing';
                return `<span class="${cssClass}">${token}</span>`;
            }).join('');
        }

        function toggleLogitLensAnimation(messageIndex) {
            const playBtn = document.querySelector(`[data-action="play"][data-message-index="${messageIndex}"]`);
            const data = logitLensData[messageIndex];

            if (!data || !data.layer_texts) {
                alert('No logit-lens data available for this message.');
                return;
            }

            if (animationIntervals[messageIndex]) {
                // Stop animation
                clearInterval(animationIntervals[messageIndex]);
                delete animationIntervals[messageIndex];
                playBtn.innerHTML = '‚ñ∂ Play';
                playBtn.classList.remove('active');
            } else {
                // Start animation
                let currentLayer = 0;
                const maxLayer = data.layer_texts.length - 1;

                playBtn.innerHTML = '‚è∏ Pause';
                playBtn.classList.add('active');

                // Update slider and display
                const slider = document.querySelector(`.layer-slider[data-message-index="${messageIndex}"]`);
                slider.value = currentLayer;
                updateLayerDisplay(messageIndex, currentLayer);

                animationIntervals[messageIndex] = setInterval(() => {
                    currentLayer++;
                    if (currentLayer > maxLayer) {
                        clearInterval(animationIntervals[messageIndex]);
                        delete animationIntervals[messageIndex];
                        playBtn.innerHTML = '‚ñ∂ Play';
                        playBtn.classList.remove('active');
                    } else {
                        slider.value = currentLayer;
                        updateLayerDisplay(messageIndex, currentLayer);
                    }
                }, 500);
            }
        }

        function resetLogitLens(messageIndex) {
            // Stop any running animation
            if (animationIntervals[messageIndex]) {
                clearInterval(animationIntervals[messageIndex]);
                delete animationIntervals[messageIndex];
            }

            // Reset to final layer
            const slider = document.querySelector(`.layer-slider[data-message-index="${messageIndex}"]`);
            const playBtn = document.querySelector(`[data-action="play"][data-message-index="${messageIndex}"]`);

            slider.value = 32;
            playBtn.innerHTML = '‚ñ∂ Play';
            playBtn.classList.remove('active');

            updateLayerDisplay(messageIndex, 32);
        }

        function toggleHighlight(messageIndex) {
            const output = document.querySelector(`.logit-lens-output[data-message-index="${messageIndex}"]`);
            const btn = document.querySelector(`[data-action="toggle-highlight"][data-message-index="${messageIndex}"]`);

            if (output.classList.contains('highlight-enabled')) {
                output.classList.remove('highlight-enabled');
                btn.classList.remove('active');
                // Remove highlighting by getting current layer and refreshing
                const slider = document.querySelector(`.layer-slider[data-message-index="${messageIndex}"]`);
                updateLayerDisplay(messageIndex, parseInt(slider.value));
            } else {
                output.classList.add('highlight-enabled');
                btn.classList.add('active');
                // Re-apply highlighting
                const slider = document.querySelector(`.layer-slider[data-message-index="${messageIndex}"]`);
                updateLayerDisplay(messageIndex, parseInt(slider.value));
            }
        }

        function toggleLogitLensSetting() {
            const toggle = document.getElementById('logitLensToggle');
            includeLogitLens = toggle.checked;
        }

        function addMessage(role, content, messageIndex = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;

            // Add click handler for user messages to enable editing
            if (role === 'user' && messageIndex !== null) {
                contentDiv.setAttribute('data-message-index', messageIndex);
                contentDiv.setAttribute('title', 'Click to edit and restart from here');
                contentDiv.addEventListener('click', function() {
                    if (!isGenerating) {
                        editMessage(messageIndex);
                    }
                });
            }

            // Add click handler for assistant messages to enable regeneration
            if (role === 'assistant' && messageIndex !== null) {
                contentDiv.setAttribute('data-message-index', messageIndex);
                contentDiv.setAttribute('title', 'Click to regenerate this response');
                contentDiv.addEventListener('click', function() {
                    if (!isGenerating) {
                        regenerateMessage(messageIndex);
                    }
                });

                // Add logit-lens play button
                const playButton = document.createElement('button');
                playButton.className = 'logit-lens-toggle';
                playButton.innerHTML = '‚ñ∂';
                playButton.setAttribute('title', 'Explore logit-lens');
                playButton.setAttribute('data-message-index', messageIndex);

                // Create logit-lens panel
                const lensPanel = document.createElement('div');
                lensPanel.className = 'logit-lens-panel';
                lensPanel.setAttribute('data-message-index', messageIndex);
                lensPanel.innerHTML = `
                    <div class="layer-scrubber">
                        <input type="range" class="layer-slider" min="0" max="32" value="32"
                               data-message-index="${messageIndex}">
                        <div class="layer-info">
                            <div class="font-semibold">Layer 32</div>
                            <div class="text-xs text-gray-500">final</div>
                        </div>
                    </div>
                    <div class="logit-lens-output" data-message-index="${messageIndex}">
                        No logit-lens data available. Enable with "Enable Logit Lens" toggle.
                    </div>
                    <div class="logit-lens-controls">
                        <button class="logit-lens-btn" data-action="play" data-message-index="${messageIndex}">
                            ‚ñ∂ Play
                        </button>
                        <button class="logit-lens-btn" data-action="reset" data-message-index="${messageIndex}">
                            ‚Ü∫ Reset
                        </button>
                        <button class="logit-lens-btn" data-action="toggle-highlight" data-message-index="${messageIndex}">
                            üîç Highlight
                        </button>
                    </div>
                `;

                playButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleLogitLens(messageIndex);
                });

                // Add event listeners for controls
                lensPanel.querySelector('.layer-slider').addEventListener('input', function(e) {
                    updateLayerDisplay(messageIndex, parseInt(e.target.value));
                });

                lensPanel.querySelector('[data-action="play"]').addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleLogitLensAnimation(messageIndex);
                });

                lensPanel.querySelector('[data-action="reset"]').addEventListener('click', function(e) {
                    e.stopPropagation();
                    resetLogitLens(messageIndex);
                });

                lensPanel.querySelector('[data-action="toggle-highlight"]').addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleHighlight(messageIndex);
                });

                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(playButton);
                messageDiv.appendChild(lensPanel);
            } else {
                messageDiv.appendChild(contentDiv);
            }
            chatWrapper.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;
            return contentDiv;
        }

        function editMessage(messageIndex) {
            // Find the message in the messages array
            if (messageIndex < 0 || messageIndex >= messages.length) return;

            const messageToEdit = messages[messageIndex];
            if (messageToEdit.role !== 'user') return;

            // Copy message content to input
            chatInput.value = messageToEdit.content;
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';

            // Remove this message and all subsequent messages from the array
            messages = messages.slice(0, messageIndex);

            // Remove message elements from DOM starting from messageIndex
            const allMessages = chatWrapper.querySelectorAll('.message');
            for (let i = messageIndex; i < allMessages.length; i++) {
                allMessages[i].remove();
            }

            vizContainer.classList.remove('visible'); // Hide visualization
            vizContainer.innerHTML = ''; // Clear it

            // Enable send button and focus input
            sendButton.disabled = false;
            chatInput.focus();
        }

        async function generateAssistantResponse() {
            isGenerating = true;
            sendButton.disabled = true;

            const assistantContent = addMessage('assistant', '');
            assistantContent.innerHTML = '<span class="typing-indicator"></span>';
            vizContainer.classList.add('visible'); // Show visualization container

            try {
                const response = await fetch(`${API_URL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: messages,
                        temperature: currentTemperature,
                        top_k: currentTopK,
                        max_tokens: 512,
                        include_logit_lens: includeLogitLens
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let receivedLogitLensData = null;
                assistantContent.textContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.token) {
                                    fullResponse += data.token;
                                    assistantContent.textContent = fullResponse;
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                                // --- Start of new visualization handling ---
                                if (data.viz_data) {
                                    let vizHtml = '<strong>Top 5 Next Token Predictions:</strong>\n';
                                    data.viz_data.forEach(item => {
                                        const probPercent = (item.prob * 100).toFixed(2);
                                        // Use textContent to prevent any potential HTML injection from token strings
                                        const pre = document.createElement('pre');
                                        pre.textContent = `${probPercent.padStart(6, ' ')}% | '${item.token}'`;
                                        vizHtml += pre.outerHTML;
                                    });
                                    vizContainer.innerHTML = vizHtml;
                                }
                                // --- Logit-lens data handling ---
                                if (data.done && data.logit_lens) {
                                    receivedLogitLensData = data.logit_lens;
                                }
                                // --- End of new visualization handling ---
                            } catch (e) {
                            }
                        }
                    }
                }

                const assistantMessageIndex = messages.length;
                messages.push({ role: 'assistant', content: fullResponse });

                // Store logit-lens data if received
                if (receivedLogitLensData) {
                    logitLensData[assistantMessageIndex] = receivedLogitLensData;
                }

                // Add click handler to regenerate this assistant message
                assistantContent.setAttribute('data-message-index', assistantMessageIndex);
                assistantContent.setAttribute('title', 'Click to regenerate this response');
                assistantContent.addEventListener('click', function() {
                    if (!isGenerating) {
                        regenerateMessage(assistantMessageIndex);
                    }
                });

            } catch (error) {
                console.error('Error:', error);
                assistantContent.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            } finally {
                isGenerating = false;
                sendButton.disabled = !chatInput.value.trim();
                // Optionally hide the visualization after generation is complete
                // setTimeout(() => vizContainer.classList.remove('visible'), 3000);
            }
        }

        async function regenerateMessage(messageIndex) {
            // Find the message in the messages array
            if (messageIndex < 0 || messageIndex >= messages.length) return;

            const messageToRegenerate = messages[messageIndex];
            if (messageToRegenerate.role !== 'assistant') return;

            // Remove this message and all subsequent messages from the array
            messages = messages.slice(0, messageIndex);

            // Remove message elements from DOM starting from messageIndex
            const allMessages = chatWrapper.querySelectorAll('.message');
            for (let i = messageIndex; i < allMessages.length; i++) {
                allMessages[i].remove();
            }

            // Regenerate the assistant response
            await generateAssistantResponse();
        }

        function handleSlashCommand(command) {
            const parts = command.trim().split(/\s+/);
            const cmd = parts[0].toLowerCase();
            const arg = parts[1];

            if (cmd === '/temperature') {
                if (arg === undefined) {
                    addMessage('console', `Current temperature: ${currentTemperature}`);
                } else {
                    const temp = parseFloat(arg);
                    if (isNaN(temp) || temp < 0 || temp > 2) {
                        addMessage('console', 'Invalid temperature. Must be between 0.0 and 2.0');
                    } else {
                        currentTemperature = temp;
                        addMessage('console', `Temperature set to ${currentTemperature}`);
                    }
                }
                return true;
            } else if (cmd === '/topk') {
                if (arg === undefined) {
                    addMessage('console', `Current top-k: ${currentTopK}`);
                } else {
                    const topk = parseInt(arg);
                    if (isNaN(topk) || topk < 1 || topk > 200) {
                        addMessage('console', 'Invalid top-k. Must be between 1 and 200');
                    } else {
                        currentTopK = topk;
                        addMessage('console', `Top-k set to ${currentTopK}`);
                    }
                }
                return true;
            } else if (cmd === '/clear') {
                newConversation();
                return true;
            } else if (cmd === '/help') {
                addMessage('console',
                    'Available commands:\n' +
                    '/temperature - Show current temperature\n' +
                    '/temperature <value> - Set temperature (0.0-2.0)\n' +
                    '/topk - Show current top-k\n' +
                    '/topk <value> - Set top-k (1-200)\n' +
                    '/clear - Clear conversation\n' +
                    '/help - Show this help message'
                );
                return true;
            }
            return false;
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isGenerating) return;

            // Handle slash commands
            if (message.startsWith('/')) {
                chatInput.value = '';
                chatInput.style.height = 'auto';
                handleSlashCommand(message);
                return;
            }

            chatInput.value = '';
            chatInput.style.height = 'auto';

            const userMessageIndex = messages.length;
            messages.push({ role: 'user', content: message });
            addMessage('user', message, userMessageIndex);

            await generateAssistantResponse();
        }

        sendButton.disabled = false;

        // Autofocus the chat input on page load
        chatInput.focus();

        fetch(`${API_URL}/health`)
            .then(response => response.json())
            .then(data => {
                console.log('Engine status:', data);
            })
            .catch(error => {
                console.error('Engine not available:', error);
                chatWrapper.innerHTML = '<div class="error-message">Engine not running. Please start engine.py first.</div>';
            });
    </script>
</body>
</html>
