# Implementation Plan: japanese-support

## Tasks

- [x] 1. 日本語データソース切り替え機能
- [x] 1.1 (P) データ設定構造体と言語別設定関数の追加
  - 言語に応じたデータソース URL を返す設定機構を実装
  - 英語は既存の fineweb-edu、日本語は fineweb-2-edu-japanese を設定
  - 環境変数 `NANOCHAT_LANG` からデフォルト言語を取得
  - テキストカラム名を設定に含める (将来の拡張に備え)
  - _Requirements: 2.1_

- [x] 1.2 parquet イテレータの言語対応
  - データ読み込み関数が言語設定を参照するよう修正
  - 言語引数を追加し環境変数より優先させる
  - 日本語 parquet ファイルの正常読み込みを確認
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 2. トークナイザ評価への日本語テキスト追加
- [x] 2.1 (P) 日本語評価サンプルテキストの追加
  - 日本語のサンプルテキスト (ニュース、技術文書等) を評価対象に追加
  - 既存の韓国語テキストと同様のパターンで実装
  - GPT-2/GPT-4/ours の圧縮率比較表に日本語行が出力されることを確認
  - _Requirements: 1.2_

- [x] 3. 日本語 SFT タスク実装
- [x] 3.1 (P) JapaneseInstruct タスククラスの作成
  - 日本語指示応答データセットを読み込む Task クラスを新規作成
  - izumi-lab/llm-japanese-dataset を HuggingFace datasets 経由でロード
  - instruction/input/output 形式を messages 形式に変換
  - input が空でない場合は instruction と連結
  - スライシング (start/stop/step) 対応
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 3.2 chat_sft への日本語タスク統合
  - SFT 学習スクリプトに日本語タスクを追加
  - TaskMixture に適切なサンプル数で組み込む
  - 日本語データを含む学習が正常に実行されることを確認
  - タスク 3.1 の完了が前提
  - _Requirements: 3.2, 3.3_

- [x] 4. 日本語評価タスク実装
- [x] 4.1 (P) JCommonsenseQA タスククラスの作成
  - 日本語常識推論ベンチマークを評価する Task クラスを新規作成
  - shunk031/JGLUE の JCommonsenseQA を HuggingFace datasets 経由でロード
  - 5択問題を多肢選択フォーマットに変換
  - choice0-choice4 を A-E にマッピング
  - label から正解レターを決定し evaluate メソッドで判定
  - _Requirements: 5.1, 5.3_

- [x] 4.2 chat_eval への日本語評価統合
  - 評価スクリプトに日本語ベンチマークを追加
  - 評価結果が report.md に出力されることを確認
  - タスク 4.1 の完了が前提
  - _Requirements: 5.1, 5.2_

- [x] 5. 統合テストと動作確認
- [x] 5.1 日本語トークナイザ学習テスト
  - 日本語データで小規模トークナイザ学習を実行
  - 日本語テキストが正しくトークナイズされることを確認
  - 圧縮率が妥当な範囲 (2-4 バイト/トークン) であることを確認
  - タスク 1.1, 1.2 の完了が前提
  - _Requirements: 1.1, 1.3, 1.4_

- [x] 5.2 日本語 SFT 学習テスト
  - 日本語会話データを含む TaskMixture で短時間 SFT を実行
  - 日本語会話データが正しくトークナイズ・学習されることを確認
  - バリデーションロスが減少することを確認
  - タスク 3.1, 3.2 の完了が前提
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 5.3 日本語評価テスト
  - JCommonsenseQA 評価を実行し精度が計算されることを確認
  - 結果が report.md に正しく記録されることを確認
  - タスク 4.1, 4.2 の完了が前提
  - _Requirements: 5.1, 5.2_

- [x] 5.4 Web UI 日本語動作確認
  - 日本語入力 → 推論 → 日本語出力のストリーミングが正常に動作することを確認
  - マルチバイト文字が途中で切れないことを確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 6. DGX Spark 日本語学習スクリプト
- [x] 6.1 speedrun_spark.sh の日本語対応
  - 既存の speedrun_spark.sh をベースに日本語学習用スクリプトを作成
  - NANOCHAT_LANG=ja 環境変数を設定
  - 日本語データセットのダウンロード・トークナイザ学習・事前学習・SFT を一貫して実行
  - タスク 1-5 の完了が前提
  - _Requirements: 1.1, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.3, 1.4 | 5.1, 6.1 |
| 1.2 | 2.1 |
| 2.1, 2.2, 2.3 | 1.1, 1.2, 6.1 |
| 3.1, 3.2, 3.3 | 3.1, 3.2, 5.2, 6.1 |
| 4.1, 4.2, 4.3, 4.4 | 5.4 |
| 5.1, 5.2, 5.3 | 4.1, 4.2, 5.3 |
